-- Adds 100 additional products with images and creates seeded orders per user

DO $$
DECLARE
    i INTEGER;
    product_id INTEGER;
    cat TEXT;
BEGIN
    FOR i IN 1..100 LOOP
        cat := CASE
                   WHEN (i % 4) = 1 THEN 'Men'
                   WHEN (i % 4) = 2 THEN 'Women'
                   WHEN (i % 4) = 3 THEN 'Accessories'
                   ELSE 'Unisex'
               END;

        INSERT INTO products (title, description, price, category, rating, created_at)
        VALUES (
            format('Drop %s Look %s', cat, i),
            format('Autogenerated %s drop #%s seeded for testing.', cat, i),
            (800 + (i * 7))::NUMERIC(10,2),
            cat,
            LEAST(4.9, 3.8 + (i % 6) * 0.2),
            NOW() - (i || ' hours')::INTERVAL
        )
        RETURNING id INTO product_id;

        INSERT INTO product_images (product_id, image_url)
        VALUES (product_id, format('https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?seed=%s', product_id));
    END LOOP;
END $$;

DO $$
DECLARE
    u RECORD;
    pid INT[];
    order_id INT;
    base_index INT := 1;
BEGIN
    SELECT array_agg(id ORDER BY id DESC) INTO pid
    FROM (SELECT id FROM products ORDER BY id DESC LIMIT 100) p;

    FOR u IN SELECT id FROM users LOOP
        IF cardinality(pid) >= base_index + 2 THEN
            INSERT INTO orders (user_id, total_amount, shipping_address, created_at)
            VALUES (u.id, 0, 'Seeded address for testing', NOW())
            RETURNING id INTO order_id;

            INSERT INTO order_items (order_id, product_id, price, quantity) VALUES
                (order_id, pid[base_index], 1299.00, 1),
                (order_id, pid[base_index + 1], 1499.00, 1),
                (order_id, pid[base_index + 2], 999.00, 2);

            UPDATE orders o
            SET total_amount = (SELECT SUM(oi.price * oi.quantity) FROM order_items oi WHERE oi.order_id = o.id)
            WHERE o.id = order_id;

            base_index := base_index + 3;
        END IF;
    END LOOP;
END $$;
